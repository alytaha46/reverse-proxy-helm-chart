name: Deploy Helm chart

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Select the environment'
        required: true
        type: choice
        options:
          - sandbox
          - maac-mgmt
  
  workflow_call:

permissions:
  id-token: write
  contents: write

jobs:    
  install_chart:
    environment: ${{ github.event.inputs.ENVIRONMENT }}
    runs-on: self-hosted
    steps:
      - uses: VFGroup-VBIT/vbitdc-opf-actions/aws/install-cli-action@main
      
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/Github-Runners-Access
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}

      - id: private-modules
        uses: VFGroup-VBIT/vbitdc-opf-actions/private-modules@main
        with:
          org: VFGroup-VBIT
          token: ${{ secrets.GHTOKEN }}

      - name: Log IP
        run: curl -s https://checkip.amazonaws.com/

      - name: Log AWS principal
        run: aws sts get-caller-identity

      - name: Install Helm
        id: install-helm
        shell: bash
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          
          aws eks update-kubeconfig --region ${{ vars.AWS_DEFAULT_REGION }} --name ${{ vars.CLUSTER_NAME }}

      - name: Install Helm chart
        shell: bash
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

          helm upgrade --install --create-namespace --namespace vgeco-reverse-proxy \
            -f ./nginxChart/config/${{ vars.AWS_ACCOUNT_NAME }}.yaml \
            test-release bitnami/nginx

      - name: Get LoadBalancer DNS
        id: get_lb_dns
        run: |
              LB_DNS=$(kubectl get svc my-service -n my-namespace -o jsonpath="{.status.loadBalancer.ingress[0].hostname}")
              echo "LB_DNS=${LB_DNS}" >> $GITHUB_ENV